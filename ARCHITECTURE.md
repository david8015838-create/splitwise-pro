# 🏗️ SplitWise Pro - 系統架構

## 📐 整體架構圖

```
┌─────────────────────────────────────────────────────────────────┐
│                         用戶端 (Browser)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    index.html (SPA)                       │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────────────┐ │  │
│  │  │   React    │  │  Tailwind  │  │  Supabase Client   │ │  │
│  │  │  (CDN)     │  │   (CDN)    │  │      (CDN)         │ │  │
│  │  └────────────┘  └────────────┘  └────────────────────┘ │  │
│  │                                                           │  │
│  │  功能模組：                                               │  │
│  │  • 房間管理    • 成員管理    • 支出管理                  │  │
│  │  • 結算計算    • 主題切換    • 即時同步                  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTPS + WebSocket
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                      Supabase (Backend)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   PostgreSQL Database                     │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │  rooms 表                                          │  │  │
│  │  │  • id (BIGSERIAL)                                  │  │  │
│  │  │  • code (TEXT) - 房間代碼                         │  │  │
│  │  │  • name (TEXT) - 房間名稱                         │  │  │
│  │  │  • data (JSONB) - 房間資料                        │  │  │
│  │  │  • created_at (TIMESTAMPTZ)                        │  │  │
│  │  │  • updated_at (TIMESTAMPTZ)                        │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  │                                                           │  │
│  │  索引：                                                   │  │
│  │  • idx_rooms_code (code)                                 │  │
│  │  • idx_rooms_updated_at (updated_at)                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   Realtime Engine                         │  │
│  │  • PostgreSQL Changes (CDC)                              │  │
│  │  • WebSocket Connections                                 │  │
│  │  • Broadcast Channels                                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   Row Level Security                      │  │
│  │  • SELECT Policy (允許所有人讀取)                        │  │
│  │  • INSERT Policy (允許所有人創建)                        │  │
│  │  • UPDATE Policy (允許所有人更新)                        │  │
│  │  • DELETE Policy (允許所有人刪除)                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                   Database Functions                      │  │
│  │  • delete_old_rooms() - 清理過期資料                     │  │
│  │  • update_updated_at_column() - 更新時間戳               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                         ▲
                         │ HTTPS API
                         │
┌────────────────────────┴────────────────────────────────────────┐
│                    GitHub Actions (自動化)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │         keep-supabase-active.yml (每天執行)              │  │
│  │                                                           │  │
│  │  Job 1: Ping Database                                    │  │
│  │  └─> GET /rest/v1/rooms?select=count                     │  │
│  │                                                           │  │
│  │  Job 2: Clean Old Data                                   │  │
│  │  └─> DELETE /rest/v1/rooms?updated_at=lt.30days          │  │
│  │                                                           │  │
│  │  觸發時間: 每天 02:00 UTC (Cron: 0 2 * * *)              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 資料流程圖

### 1. 創建房間流程

```
用戶操作
   │
   ▼
生成 6 位數房號
   │
   ▼
創建房間資料
{
  code: "123456",
  name: "週末小旅行",
  members: [...],
  expenses: []
}
   │
   ▼
呼叫 Supabase API
INSERT INTO rooms
   │
   ▼
PostgreSQL 儲存
   │
   ▼
Realtime 推送
   │
   ▼
所有訂閱者收到更新
   │
   ▼
UI 自動更新
```

### 2. 即時同步流程

```
用戶 A 修改資料
   │
   ▼
更新本地 State
   │
   ▼
呼叫 Supabase API
UPDATE rooms SET data = ...
   │
   ▼
PostgreSQL 更新
   │
   ▼
觸發 Realtime
   │
   ├─────────────┬─────────────┐
   ▼             ▼             ▼
用戶 A        用戶 B        用戶 C
(發起者)      (訂閱者)      (訂閱者)
   │             │             │
   ▼             ▼             ▼
UI 已更新     收到推送      收到推送
              │             │
              ▼             ▼
           更新 State    更新 State
              │             │
              ▼             ▼
           UI 更新       UI 更新
```

### 3. 自動清理流程

```
GitHub Actions
(每天 02:00 UTC)
   │
   ▼
計算 30 天前日期
   │
   ▼
呼叫 Supabase API
DELETE FROM rooms
WHERE updated_at < 30 days ago
   │
   ▼
PostgreSQL 執行刪除
   │
   ▼
返回刪除數量
   │
   ▼
記錄執行日誌
```

---

## 🧩 前端組件架構

```
App (主組件)
│
├─ State Management
│  ├─ view (當前視圖)
│  ├─ roomData (房間資料)
│  ├─ isDarkMode (主題模式)
│  ├─ history (歷史記錄)
│  └─ ...
│
├─ Views (視圖)
│  ├─ Landing (首頁)
│  ├─ Room (房間主頁)
│  ├─ AddExpense (新增支出)
│  └─ Settle (結算報告)
│
├─ Components (組件)
│  ├─ Icon (圖標)
│  ├─ GlassCard (玻璃卡片)
│  └─ Modal (彈窗)
│
├─ Hooks (鉤子)
│  ├─ useEffect (初始化、訂閱)
│  └─ useMemo (計算結算)
│
└─ Functions (函數)
   ├─ createRoom (創建房間)
   ├─ joinRoom (加入房間)
   ├─ saveRoomToCloud (儲存資料)
   ├─ handleAddExpense (新增支出)
   ├─ handleAddMember (新增成員)
   ├─ calculateSettlements (計算結算)
   └─ toggleTheme (切換主題)
```

---

## 🗄️ 資料庫架構

### rooms 表結構

```sql
CREATE TABLE rooms (
    id BIGSERIAL PRIMARY KEY,
    code TEXT UNIQUE NOT NULL,
    name TEXT NOT NULL,
    data JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### data JSONB 結構

```json
{
  "code": "123456",
  "name": "週末小旅行",
  "members": [
    {
      "id": "m_1234567890",
      "name": "小明"
    },
    {
      "id": "m_9876543210",
      "name": "小華"
    }
  ],
  "expenses": [
    {
      "id": "e_1234567890",
      "title": "晚餐",
      "amount": 500,
      "payerId": "m_1234567890",
      "participants": ["m_1234567890", "m_9876543210"],
      "splitMode": "equal",
      "customAmounts": {}
    },
    {
      "id": "e_9876543210",
      "title": "住宿",
      "amount": 2000,
      "payerId": "m_9876543210",
      "participants": ["m_1234567890", "m_9876543210"],
      "splitMode": "exact",
      "customAmounts": {
        "m_1234567890": "800",
        "m_9876543210": "1200"
      }
    }
  ]
}
```

---

## 🔐 安全架構

```
┌─────────────────────────────────────────────────────────────────┐
│                         安全層級                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Level 1: 傳輸層安全                                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  • HTTPS 加密傳輸                                         │  │
│  │  • WebSocket Secure (WSS)                                │  │
│  │  • TLS 1.3                                               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Level 2: API 認證                                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  • API Key (anon public)                                 │  │
│  │  • JWT Token                                             │  │
│  │  • Rate Limiting                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Level 3: 資料庫安全                                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  • Row Level Security (RLS)                              │  │
│  │  • PostgreSQL Policies                                   │  │
│  │  • 連接池管理                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Level 4: 應用層安全                                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  • 輸入驗證                                              │  │
│  │  • XSS 防護                                              │  │
│  │  • CSRF 防護                                             │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Level 5: 隱私保護                                               │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  • 30 天自動清理                                         │  │
│  │  • 無個人資料收集                                        │  │
│  │  • 無需註冊                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🚀 部署架構

```
┌─────────────────────────────────────────────────────────────────┐
│                      部署選項                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  選項 A: Vercel                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  GitHub Repo → Vercel → CDN → 全球節點                   │  │
│  │  • 自動部署                                              │  │
│  │  • 全球 CDN                                              │  │
│  │  • 免費 SSL                                              │  │
│  │  • 自定義域名                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  選項 B: GitHub Pages                                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  GitHub Repo → GitHub Pages → 靜態網站                   │  │
│  │  • 免費託管                                              │  │
│  │  • 自動部署                                              │  │
│  │  • 免費 SSL                                              │  │
│  │  • username.github.io                                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  選項 C: Netlify                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  拖放部署 → Netlify → CDN → 全球節點                     │  │
│  │  • 拖放部署                                              │  │
│  │  • 全球 CDN                                              │  │
│  │  • 免費 SSL                                              │  │
│  │  • 表單處理                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 效能架構

```
┌─────────────────────────────────────────────────────────────────┐
│                      效能優化                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  前端優化                                                        │
│  • React useMemo (緩存計算)                                     │
│  • 防抖輸入處理                                                  │
│  • CSS 過渡動畫                                                  │
│  • 圖片懶加載 (未來)                                             │
│                                                                  │
│  資料庫優化                                                      │
│  • 索引優化 (code, updated_at)                                  │
│  • JSONB 欄位存儲                                                │
│  • 連接池管理                                                    │
│  • 查詢優化                                                      │
│                                                                  │
│  網路優化                                                        │
│  • CDN 加速 (React, Tailwind, Supabase)                         │
│  • Gzip 壓縮                                                     │
│  • HTTP/2                                                        │
│  • WebSocket 長連接                                              │
│                                                                  │
│  快取策略                                                        │
│  • LocalStorage (歷史記錄、主題設置)                            │
│  • 瀏覽器快取                                                    │
│  • Supabase 快取                                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 CI/CD 流程

```
開發者提交代碼
   │
   ▼
Git Push to GitHub
   │
   ├─────────────────┬─────────────────┐
   ▼                 ▼                 ▼
GitHub Actions   部署平台          Supabase
   │                 │                 │
   ▼                 ▼                 ▼
自動測試          自動部署          資料庫
   │                 │                 │
   ▼                 ▼                 ▼
Ping DB          CDN 分發          Realtime
   │                 │                 │
   ▼                 ▼                 ▼
清理資料          全球節點          即時同步
   │                 │                 │
   └─────────────────┴─────────────────┘
                     │
                     ▼
                 用戶訪問
```

---

## 📈 擴展架構（未來）

```
當前架構 (v2.0)
   │
   ├─ 單一資料庫
   ├─ 無用戶系統
   └─ 基本功能
   │
   ▼
未來架構 (v3.0)
   │
   ├─ 多區域部署
   │  ├─ 亞洲節點
   │  ├─ 歐洲節點
   │  └─ 美洲節點
   │
   ├─ 用戶系統
   │  ├─ 註冊/登入
   │  ├─ OAuth (Google, Facebook)
   │  └─ 權限管理
   │
   ├─ 進階功能
   │  ├─ 照片上傳 (Supabase Storage)
   │  ├─ 推送通知 (Web Push)
   │  ├─ 離線支援 (Service Worker)
   │  └─ PWA 支援
   │
   └─ 分析系統
      ├─ 使用統計
      ├─ 錯誤追蹤
      └─ 效能監控
```

---

## 🎯 技術決策

### 為什麼選擇 Supabase？
- ✅ 開源且免費
- ✅ 內建 Realtime
- ✅ PostgreSQL 強大
- ✅ 易於使用
- ✅ 良好的文檔

### 為什麼使用 CDN？
- ✅ 無需打包工具
- ✅ 快速載入
- ✅ 自動更新
- ✅ 簡化部署

### 為什麼選擇 JSONB？
- ✅ 靈活的資料結構
- ✅ 支援複雜查詢
- ✅ 高效能
- ✅ 易於擴展

---

**最後更新**: 2026-01-13
**版本**: 2.0.0
