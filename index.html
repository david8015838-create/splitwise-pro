<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SplitWise Pro - Safari Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #020617; color: white; overflow: hidden; width: 100vw; height: 100dvh; }
        #root { height: 100%; width: 100%; }
        .btn-active:active { transform: scale(0.96); }
        .ios-inset { padding-bottom: env(safe-area-inset-bottom); }
        .scroll-container { height: 100%; overflow-y: auto; display: flex; flex-direction: column; }
        input { -webkit-appearance: none; border-radius: 1rem; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        // 核心載入邏輯：確保 Firebase 先於 React 執行
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'splitwise-v1';

        // 將 SDK 掛載到全局，讓 React 可以存取
        window.FBASE = { db, auth, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, collection, signInAnonymously, onAuthStateChanged, signInWithCustomToken, appId };
        
        // 觸發自定義事件，通知 React 準備就緒
        window.dispatchEvent(new Event('fbase-init-complete'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 圖標組件
        const Icon = ({ name, className = "w-5 h-5" }) => {
            const icons = {
                chart: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>,
                plus: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" /></svg>,
                trash: <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" className={className}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            };
            return icons[name] || <span>•</span>;
        };

        const App = () => {
            const [status, setStatus] = useState('initializing'); // initializing, ready
            const [user, setUser] = useState(null);
            const [view, setView] = useState('landing');
            const [loading, setLoading] = useState(false);
            
            // 表單狀態
            const [roomName, setRoomName] = useState('');
            const [userName, setUserName] = useState('');
            const [joinCode, setJoinCode] = useState('');

            // 1. 監聽 Firebase 初始化
            useEffect(() => {
                const checkInit = async () => {
                    if (window.FBASE) {
                        const { auth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.FBASE;
                        
                        // 嘗試登入
                        try {
                            if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                                await signInWithCustomToken(auth, window.__initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) { console.error("Auth Fail", e); }

                        onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            setStatus('ready');
                        });
                    }
                };

                window.addEventListener('fbase-init-complete', checkInit);
                checkInit();
                return () => window.removeEventListener('fbase-init-complete', checkInit);
            }, []);

            // 創建房間邏輯
            const handleCreate = async () => {
                if (loading) return;
                
                // Safari 友好的提示
                if (status !== 'ready' || !user) {
                    alert("正在連線至伺服器，請稍候 3 秒後再試...");
                    return;
                }

                if (!userName.trim()) {
                    alert("請輸入您的暱稱");
                    return;
                }

                setLoading(true);
                try {
                    const { db, doc, setDoc, serverTimestamp, appId } = window.FBASE;
                    const code = Math.floor(100000 + Math.random() * 900000).toString();
                    const newRoom = {
                        name: roomName || '我的分帳房間',
                        code: code,
                        members: [{ id: Date.now().toString(), name: userName }],
                        expenses: [],
                        createdAt: serverTimestamp()
                    };
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code), newRoom);
                    alert("成功創建房間！房號：" + code);
                    // 這裡可以跳轉到房間頁面，目前先停留
                } catch (err) {
                    console.error(err);
                    alert("創建失敗，請檢查網路。");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="scroll-container items-center justify-center px-8">
                    <div className="w-full max-w-md animate-in">
                        <div className="text-center mb-10">
                            <div className="w-20 h-20 bg-indigo-600 rounded-[28px] flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-indigo-500/40 transform rotate-6">
                                <Icon name="chart" className="w-10 h-10 text-white" />
                            </div>
                            <h1 className="text-3xl font-black tracking-tight">SplitWise <span className="text-indigo-500">Pro</span></h1>
                            <p className="text-slate-500 mt-2 font-medium">針對 Safari 優化版</p>
                        </div>

                        <div className="bg-slate-900/50 p-6 rounded-[32px] border border-slate-800 space-y-4">
                            <div className="space-y-3">
                                <label className="text-xs font-black text-slate-500 uppercase tracking-widest ml-1">快速開始</label>
                                <input 
                                    type="text"
                                    value={roomName}
                                    onChange={e => setRoomName(e.target.value)}
                                    placeholder="房間名稱 (選填)"
                                    className="w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl outline-none focus:border-indigo-500 transition-all text-white placeholder:text-slate-600"
                                />
                                <input 
                                    type="text"
                                    value={userName}
                                    onChange={e => setUserName(e.target.value)}
                                    placeholder="您的暱稱"
                                    className="w-full p-4 bg-slate-800 border border-slate-700 rounded-2xl outline-none focus:border-indigo-500 transition-all text-white placeholder:text-slate-600"
                                />
                            </div>

                            <button 
                                onClick={handleCreate}
                                className={`w-full py-4 rounded-2xl font-black text-lg btn-active transition-all ${
                                    loading ? 'bg-slate-700 text-slate-400' : 'bg-indigo-600 text-white shadow-xl shadow-indigo-900/20'
                                }`}
                            >
                                {loading ? '處理中...' : '創建房間'}
                            </button>

                            <div className="flex items-center gap-4 py-2">
                                <div className="h-px bg-slate-800 flex-1"></div>
                                <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest">或</span>
                                <div className="h-px bg-slate-800 flex-1"></div>
                            </div>

                            <div className="flex gap-2">
                                <input 
                                    type="number"
                                    value={joinCode}
                                    onChange={e => setJoinCode(e.target.value)}
                                    placeholder="輸入 6 位房號"
                                    className="flex-1 p-4 bg-slate-800 border border-slate-700 rounded-2xl outline-none focus:border-indigo-500 text-center font-black tracking-widest"
                                />
                                <button className="px-6 bg-slate-200 text-slate-900 rounded-2xl font-black btn-active">加入</button>
                            </div>
                        </div>

                        <div className="mt-8 text-center">
                            <span className="inline-flex items-center gap-2 px-4 py-2 bg-slate-900 rounded-full border border-slate-800">
                                <div className={`w-2 h-2 rounded-full ${status === 'ready' ? 'bg-green-500 animate-pulse' : 'bg-amber-500'}`}></div>
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                    {status === 'ready' ? '伺服器已連線' : '正在連線...'}
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
